# Author @patriciogv - 2015

import:
    - http://tangrams.github.io/blocks/color/tools.yaml
    - http://tangrams.github.io/blocks/generative/noise.yaml
    - http://tangrams.github.io/blocks/space/tile.yaml
    - http://tangrams.github.io/blocks/tiling/texture/zoom-fade.yaml
    - http://tangrams.github.io/blocks/filter/hatch.yaml

sources:
    osm:
        type: TopoJSON
        url: https://vector.mapzen.com/osm/all/{z}/{x}/{y}.topojson?api_key=vector-tiles-JUsa0Gc

textures:
    hatch_0: 
        url: imgs/hatch_0.png
    hatch_2: 
        url: imgs/hatch_2.png
    paper:
        url: imgs/normal-0031.jpg

scene:
    background:
        color: [0.302,0.302,0.306]

cameras:
    cam:
        type: perspective

lights:
    dir:
        type: directional
        direction: [0, 1, -.5]
        diffuse: .5
        ambient: .3
    pnt:
        type: point
        position: [0, -500px, 500px]
        origin: ground
        diffuse: .5
        ambient: .3

global:
    order: function () { return feature.sort_key; }
    pseudoRandomColor: |
        function() {
            return [
                0.7 * (parseInt(feature.id, 16) / 100 % 1),     // jshint ignore:line
                0.7 * (parseInt(feature.id, 16) / 10000 % 1),   // jshint ignore:line
                0.7 * (parseInt(feature.id, 16) / 1000000 % 1), // jshint ignore:line
                1
            ];
        }

layers:
    earth:
        data: { source: osm }
        draw:
            earth-hatch:
                order: global.order
                color: [[14,[1.,1.,1.]],[18,[1.,1.,1.]]]
    landuse:
        data: { source: osm }
        draw:
            landuse-hatch:
                order: global.order
                color: [0.302,0.302,0.306]
    water:
        data: { source: osm }
        draw:
            paper:
                order: global.order
                color: '#343434'
    roads:
        data: { source: osm }
        filter: { not: { kind: [rail, ferry] } }
        draw:
            ink-lines:
                order: global.order
                color: '#343434'
                width: 8
    buildings:
        data: { source: osm }
        draw:
            buildings:
                order: global.order
                color: global.pseudoRandomColor
        extruded:
            filter: { $zoom: { min: 13 } }
            draw:
                buildings:
                    extrude: true
                buildingsLines:
                    order: global.order
                    width: [[12, .1px], [14, 0.1px], [15, 0.5px], [17, 1.0px], [18, 1px]]
                    extrude: true
                    color: [0.217,0.217,0.217]
    places:
        data: { source: osm }
        filter: { name: true }
        draw:
            text:
                font:
                    family: Baskerville
                    size: 20px
                    style: italic
                    fill: black
                    stroke: { color: [0.976,0.953,0.890] , width: 7 }
    landuse_labels:
        data: { source: osm }
        filter: { name: true, kind: park, $zoom: { min: 16 } }
        draw:
            text:
                font:
                    family: Baskerville
                    size: 18px
                    style: italic
                    fill: black
                    stroke: { color: [0.976,0.953,0.890] , width: 7 }
styles:
    earth-hatch:
        base: polygons
        lighting: false
        mix: tiling-texture-zoom-fade 
        shaders:
            uniforms:
                    u_hatch: hatch_0
            blocks:
                filter: |
                    float pattern = 1.0-TileTexture(u_hatch,3.).a;
                    color.rgb = mix(vec3(0.302,0.302,0.306), vec3(0.976,0.953,0.890), pattern);
    landuse-hatch:
        base: polygons
        mix: earth-hatch
        shaders:
            uniforms:
                    u_hatch: hatch_2
    paper:
        base: polygons
        texcoords: true
        material:
            normal:
                texture: paper
                mapping: planar
                scale: 0.001
            ambient: 1.
            diffuse: 1.
    ink-lines:
        base: lines
        mix: generative-noise
        texcoords: true
        lighting: false
        shaders:
            blocks:
                filter: |
                    vec2 uv = fract(v_texcoord*vec2(1.,.1));
                    color.rgb = mix(vec3(0.302,0.302,0.306),vec3(0.976,0.953,0.890),1.0-(smoothstep(0.0,0.1,uv.x) * smoothstep(0.0,0.1,1.0-uv.x)+noise(uv*vec2(2.,70.)) ));
    buildings:
        base: polygons
        mix: [color-tools, generative-noise, filter-hatch]
        texcoords: true
        material:
            ambient: 1.
            diffuse: 1.
        shaders:
            blocks:
                position: |
                    position.z *= max(1.0,0.5+(1.0-(u_map_position.z/20.0))*5.0);
                filter: |
                    vec2 uv = v_texcoord;
                    float b = getBrightness(light_accumulator_diffuse.rgb);
                    b *=  clamp(uv.y*1.5,0.0,1.0)+0.2;

                    float pattern = 1.-getHatch(uv,b);
                    vec2 edge = vec2(0.1,0.05)*noise(uv*20.);
                    vec2 blend = smoothstep(vec2(0.0),edge,uv)*smoothstep(vec2(0.0),edge,vec2(1.)-uv);

                    color.rgb = mix(vec3(0.302,0.302,0.306), vec3(0.976,0.953,0.890), mix(1.0,pattern,blend.x*blend.y));
    buildingsLines:
        base: lines
        lighting: false
        shaders:
            blocks:
                width: |
                    width *= 0.2+min(pow(position.z*0.006,2.),.6);
                position: |
                    position.z *= max(1.0,0.5+(1.0-(u_map_position.z/20.0))*5.0);
